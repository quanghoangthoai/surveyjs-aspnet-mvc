<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Supplier Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: #1f2933;
    }
    header {
      background-color: #243b53;
      color: #ffffff;
      padding: 1.5rem 2rem;
    }
    main {
      padding: 2rem;
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0;
      font-size: 1.75rem;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      padding: 1.75rem;
      margin-bottom: 2rem;
    }
    label {
      display: block;
      margin-bottom: 0.35rem;
      font-weight: 600;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 8px;
      border: 1px solid #cbd2d9;
      font-size: 1rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 90px;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3e7bfa;
      box-shadow: 0 0 0 3px rgba(62, 123, 250, 0.25);
    }
    button {
      background-color: #3e7bfa;
      color: #ffffff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.1s ease;
      margin-top: 0.75rem;
    }
    button:hover {
      background-color: #2f64d6;
    }
    button:active {
      transform: scale(0.99);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem 1.5rem;
    }
    .form-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .message.success {
      background-color: #ecfdf3;
      color: #047857;
      border: 1px solid #6ee7b7;
    }
    .message.error {
      background-color: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e4ebf5;
    }
    th {
      background-color: #f0f4f8;
      font-weight: 700;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.65rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 600;
      background-color: #edf2ff;
      color: #1d4ed8;
    }
    .muted {
      color: #52606d;
    }
    .toggle-row {
      margin-top: 1rem;
    }
    .checkbox {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }
    .checkbox input {
      width: auto;
      height: 1rem;
      width: 1rem;
    }
    @media (max-width: 640px) {
      header {
        padding: 1rem 1.25rem;
      }
      main {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Supplier Management</h1>
    <p>Define suppliers (NCC), link them to surveys, and control the order respondents will see them.</p>
  </header>

  <main>
    <section class="card">
      <h2>Create Supplier</h2>
      <p class="muted">Provide supplier details and optionally link an existing survey. Leave “Survey” blank to assign later.</p>

      <div id="feedback" role="status" aria-live="polite"></div>

      <form id="supplierForm" novalidate>
        <div class="form-grid">
          <div>
            <label for="supplierName">Name *</label>
            <input id="supplierName" name="name" type="text" required placeholder="e.g. Supplier A" />
          </div>

          <div>
            <label for="displayOrder">Display Order</label>
            <input id="displayOrder" name="displayOrder" type="number" min="1" placeholder="Auto if empty" />
          </div>

          <div>
            <label for="surveySelect">Link Survey</label>
            <select id="surveySelect" name="surveyId">
              <option value="">(No survey)</option>
            </select>
          </div>
        </div>

        <div style="margin-top: 1rem;">
          <label for="supplierDescription">Description</label>
          <textarea id="supplierDescription" name="description" placeholder="Additional notes or identifiers..."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit">Create Supplier</button>
          <button type="button" id="resetButton">Reset</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Create Survey</h2>
      <p class="muted">Create a new survey by selecting a template or starting from a blank form. Optionally link it to a supplier so it appears in the NCC workflow.</p>

      <div id="surveyFeedback" role="status" aria-live="polite"></div>

      <form id="surveyForm" novalidate>
        <div class="form-grid">
          <div>
            <label for="surveyName">Survey Name</label>
            <input id="surveyName" name="surveyName" type="text" placeholder="Leave empty to use template name" />
          </div>
          <div>
            <label for="surveySupplier">Supplier</label>
            <select id="surveySupplier" name="supplierId">
              <option value="">(Standalone survey)</option>
            </select>
          </div>
          <div>
            <label for="surveyTemplate">Template</label>
            <select id="surveyTemplate" name="templateId">
              <option value="">Blank survey</option>
            </select>
          </div>
        </div>

        <div class="toggle-row">
          <label class="checkbox">
            <input type="checkbox" id="surveyIsSupplier" name="isSupplierEvaluation" checked />
            <span>Survey evaluates a supplier</span>
          </label>
        </div>

        <div class="form-actions">
          <button type="submit">Create Survey</button>
          <button type="button" id="surveyResetButton">Reset</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Suppliers</h2>
      <p class="muted">Suppliers are listed in processing order. After respondents finish one supplier survey, the next one is served automatically.</p>

      <table aria-label="Suppliers table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Description</th>
            <th>Order</th>
            <th>Linked Survey</th>
          </tr>
        </thead>
        <tbody id="suppliersTableBody">
          <tr>
            <td colspan="5" class="muted">Loading suppliers...</td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    const supplierForm = document.getElementById('supplierForm');
    const feedback = document.getElementById('feedback');
    const surveySelect = document.getElementById('surveySelect');
    const suppliersTableBody = document.getElementById('suppliersTableBody');
    const resetButton = document.getElementById('resetButton');

    const surveyForm = document.getElementById('surveyForm');
    const surveyFeedback = document.getElementById('surveyFeedback');
    const surveyName = document.getElementById('surveyName');
    const surveySupplierSelect = document.getElementById('surveySupplier');
    const surveyTemplateSelect = document.getElementById('surveyTemplate');
    const surveyIsSupplierCheckbox = document.getElementById('surveyIsSupplier');
    const surveyResetButton = document.getElementById('surveyResetButton');

    let cachedSurveys = [];
    let cachedSuppliers = [];
    let cachedTemplates = [];

    function showMessage(type, text) {
      feedback.innerHTML = '';
      if (!text) {
        return;
      }
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      feedback.appendChild(message);
    }

    function showSurveyMessage(type, text) {
      surveyFeedback.innerHTML = '';
      if (!text) {
        return;
      }
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      surveyFeedback.appendChild(message);
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      if (!response.ok) {
        const detail = await response.text();
        throw new Error(detail || response.statusText);
      }
      return response.json();
    }

    async function loadSurveys() {
      surveySelect.disabled = true;
      surveySelect.innerHTML = '<option value="">(No survey)</option>';
      try {
        const surveys = await fetchJson('/api/getActive');
        cachedSurveys = Array.isArray(surveys) ? surveys.filter(Boolean) : [];
        cachedSurveys.forEach(survey => {
          const option = document.createElement('option');
          option.value = survey.id;
          option.textContent = `${survey.name} (ID: ${survey.id})${survey.isSupplierEvaluation ? '' : ' — standalone'}`;
          surveySelect.appendChild(option);
        });
        refreshSurveyTemplateOptions();
      } catch (error) {
        showMessage('error', `Unable to load surveys: ${error.message}`);
      } finally {
        surveySelect.disabled = false;
      }
    }

    function refreshSurveyTemplateOptions() {
      if (!surveyTemplateSelect) {
        return;
      }

      const previousValue = surveyTemplateSelect.value;
      surveyTemplateSelect.innerHTML = '';

      const blankOption = document.createElement('option');
      blankOption.value = '';
      blankOption.textContent = 'Blank survey';
      surveyTemplateSelect.appendChild(blankOption);

      if (cachedTemplates.length) {
        const templateGroup = document.createElement('optgroup');
        templateGroup.label = 'Default templates';
        cachedTemplates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.textContent = template.name;
          templateGroup.appendChild(option);
        });
        surveyTemplateSelect.appendChild(templateGroup);
      }

      if (cachedSurveys.length) {
        const existingGroup = document.createElement('optgroup');
        existingGroup.label = 'Existing surveys';
        cachedSurveys.forEach(survey => {
          const option = document.createElement('option');
          option.value = `existing-${survey.id}`;
          option.textContent = `${survey.name} (ID: ${survey.id})`;
          existingGroup.appendChild(option);
        });
        surveyTemplateSelect.appendChild(existingGroup);
      }

      const hasPrevious = Array.from(surveyTemplateSelect.options).some(option => option.value === previousValue);
      surveyTemplateSelect.value = hasPrevious ? previousValue : '';
    }

    function populateSupplierOptions(suppliers) {
      if (!surveySupplierSelect) {
        return;
      }

      const previousValue = surveySupplierSelect.value;
      surveySupplierSelect.innerHTML = '<option value="">(Standalone survey)</option>';

      suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier.id;
        const suffix = supplier.surveyId ? ` — has survey ${supplier.surveyId}` : '';
        option.textContent = `${supplier.name}${suffix}`;
        surveySupplierSelect.appendChild(option);
      });

      const hasPrevious = Array.from(surveySupplierSelect.options).some(option => option.value === previousValue);
      surveySupplierSelect.value = hasPrevious ? previousValue : '';
      if (!surveyIsSupplierCheckbox.checked) {
        surveySupplierSelect.value = '';
        surveySupplierSelect.disabled = true;
      }
    }

    function renderSuppliers(suppliers) {
      suppliersTableBody.innerHTML = '';
      if (!suppliers.length) {
        suppliersTableBody.innerHTML = '<tr><td colspan="5" class="muted">No suppliers defined yet.</td></tr>';
        return;
      }

      suppliers.forEach((supplier, index) => {
        const row = document.createElement('tr');
        const linkedSurvey = supplier.surveyId
          ? `<span class="tag">Survey ${supplier.surveyId}</span>`
          : '<span class="muted">—</span>';
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${supplier.name}</td>
          <td>${supplier.description || '<span class="muted">—</span>'}</td>
          <td>${supplier.displayOrder}</td>
          <td>${linkedSurvey}</td>
        `;
        suppliersTableBody.appendChild(row);
      });
    }

    async function loadSuppliers() {
      suppliersTableBody.innerHTML = '<tr><td colspan="5" class="muted">Loading suppliers...</td></tr>';
      try {
        const suppliers = await fetchJson('/api/suppliers');
        cachedSuppliers = Array.isArray(suppliers) ? suppliers : [];
        renderSuppliers(cachedSuppliers);
        populateSupplierOptions(cachedSuppliers);
      } catch (error) {
        suppliersTableBody.innerHTML = '<tr><td colspan="5" class="muted">Failed to load suppliers.</td></tr>';
        showMessage('error', `Unable to load suppliers: ${error.message}`);
      }
    }

    async function loadSurveyTemplates() {
      showSurveyMessage('', '');
      try {
        const templates = await fetchJson('/api/surveys/templates');
        cachedTemplates = Array.isArray(templates) ? templates : [];
      } catch (error) {
        cachedTemplates = [];
        showSurveyMessage('error', `Unable to load default templates: ${error.message}`);
      } finally {
        refreshSurveyTemplateOptions();
      }
    }

    supplierForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showMessage('', '');

      const formData = new FormData(supplierForm);
      const name = formData.get('name')?.trim();
      const description = formData.get('description')?.trim();
      const displayOrderRaw = formData.get('displayOrder')?.trim();
      const surveyId = formData.get('surveyId')?.trim();

      if (!name) {
        showMessage('error', 'Supplier name is required.');
        return;
      }

      const payload = {
        name,
        description: description || null,
        displayOrder: displayOrderRaw ? Number(displayOrderRaw) : 0,
        surveyId: surveyId || null
      };

      try {
        const created = await fetchJson('/api/suppliers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        showMessage('success', `Supplier "${created.name}" created successfully.`);
        supplierForm.reset();
        await loadSuppliers();
        await loadSurveys();
      } catch (error) {
        showMessage('error', `Failed to create supplier: ${error.message}`);
      }
    });

    surveyForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showSurveyMessage('', '');

      const name = surveyName.value.trim();
      const supplierIdValue = surveySupplierSelect.disabled ? '' : surveySupplierSelect.value.trim();
      const templateId = surveyTemplateSelect.value;
      const isSupplierEvaluation = surveyIsSupplierCheckbox.checked;

      const params = new URLSearchParams();
      if (name) {
        params.append('name', name);
      }
      params.append('isSupplierEvaluation', String(isSupplierEvaluation));
      if (isSupplierEvaluation && supplierIdValue) {
        params.append('supplierId', supplierIdValue);
      }
      if (templateId) {
        params.append('templateId', templateId);
      }

      const url = `/api/create${params.toString() ? `?${params.toString()}` : ''}`;

      try {
        const createdSurvey = await fetchJson(url);
        showSurveyMessage('success', `Survey "${createdSurvey.name}" created successfully.`);
        surveyForm.reset();
        surveyIsSupplierCheckbox.checked = true;
        surveySupplierSelect.disabled = false;
        await Promise.all([loadSurveys(), loadSuppliers()]);
      } catch (error) {
        showSurveyMessage('error', `Failed to create survey: ${error.message}`);
      }
    });

    surveyResetButton.addEventListener('click', () => {
      surveyForm.reset();
      surveyIsSupplierCheckbox.checked = true;
      surveySupplierSelect.disabled = false;
      showSurveyMessage('', '');
    });

    surveyIsSupplierCheckbox.addEventListener('change', () => {
      if (surveyIsSupplierCheckbox.checked) {
        surveySupplierSelect.disabled = false;
      } else {
        surveySupplierSelect.disabled = true;
        surveySupplierSelect.value = '';
      }
    });

    surveySupplierSelect.addEventListener('change', () => {
      if (surveySupplierSelect.value) {
        surveyIsSupplierCheckbox.checked = true;
        surveySupplierSelect.disabled = false;
      }
    });

    resetButton.addEventListener('click', () => {
      supplierForm.reset();
      showMessage('', '');
    });

    window.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([loadSurveyTemplates(), loadSurveys(), loadSuppliers()]);
    });
  </script>
</body>
</html>

